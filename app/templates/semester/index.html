{% extends 'base.html' %}

{% block title %}Semestre - Uni-App{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Gestión por Semestre</h1>
            <p class="text-sm text-gray-500 mt-1">Administra las materias de cada semestre</p>
        </div>
        <div class="flex items-center space-x-4">
            <label class="text-sm font-medium text-gray-700">Seleccionar semestre:</label>
            <select id="semester-select" onchange="loadSemester(this.value)"
                    class="border-gray-300 rounded-lg focus:ring-accent-500 focus:border-accent-500">
                <!-- Options populated by JS -->
            </select>
        </div>
    </div>
    
    <!-- Semester Stats -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500">Promedio Semestral</p>
            <p class="text-2xl font-bold text-accent-600" id="semester-gpa">--</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500">Créditos del Semestre</p>
            <p class="text-2xl font-bold text-gray-900">
                <span id="semester-credits">0</span> / <span id="semester-max-credits">21</span>
            </p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500">Materias</p>
            <p class="text-2xl font-bold text-gray-900" id="semester-courses-count">0</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-500">Estado</p>
            <p class="text-lg font-semibold" id="semester-status">
                <span class="text-gray-500">--</span>
            </p>
        </div>
    </div>
    
    <!-- Semester Courses Grid -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Materias del Semestre <span id="current-semester-num">1</span></h2>
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500">Clic en <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg> para mover</span>
            </div>
        </div>
        
        <div id="semester-courses-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Course cards will be populated here -->
            <div class="col-span-full text-center py-12 text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                <p class="mt-2">No hay materias en este semestre</p>
            </div>
        </div>
    </div>
    
    <!-- Other Semesters (for drag-drop) -->
    <div class="bg-gray-50 rounded-xl p-6">
        <h3 class="text-sm font-medium text-gray-700 mb-4">Mover a otro semestre</h3>
        <div id="other-semesters-drop" class="grid grid-cols-5 sm:grid-cols-8 lg:grid-cols-10 gap-2">
            <!-- Semester drop zones will be populated here -->
        </div>
    </div>
    
    <!-- Status Legend -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Leyenda de Estados</h3>
        <div class="flex flex-wrap gap-4">
            <div class="flex items-center space-x-2">
                <span class="w-3 h-3 rounded-full bg-gray-300"></span>
                <span class="text-sm text-gray-600">Pendiente</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                <span class="text-sm text-gray-600">En curso</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                <span class="text-sm text-gray-600">Aprobada</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="w-3 h-3 rounded-full bg-red-500"></span>
                <span class="text-sm text-gray-600">Reprobada</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                <span class="text-sm text-gray-600">Retirada</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="w-3 h-3 rounded-full bg-gray-500"></span>
                <span class="text-sm text-gray-600">Bloqueada</span>
            </div>
        </div>
    </div>
</div>

<!-- Move Confirmation Modal -->
<div id="move-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" onclick="closeMoveModal()"></div>
        <div class="relative bg-white rounded-xl shadow-xl max-w-md w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Mover Materia</h3>
            <p id="move-modal-message" class="text-sm text-gray-600 mb-4"></p>
            <div id="move-modal-warnings" class="hidden mb-4 p-3 bg-yellow-50 rounded-lg">
                <p class="text-sm text-yellow-700"></p>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeMoveModal()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                    Cancelar
                </button>
                <button id="move-confirm-btn" onclick="confirmMove()"
                        class="px-4 py-2 text-sm font-medium text-white bg-accent-500 rounded-lg hover:bg-accent-600">
                    Mover
                </button>
            </div>
        </div>
    </div>
</div>

{% include 'components/course_modal.html' %}
{% include 'components/alert.html' %}

{% endblock %}

{% block scripts %}
<script>
    let currentSemester = 1;
    let selectedMateriaToMove = null; // Track which materia is selected for moving
    
    document.addEventListener('DOMContentLoaded', function() {
        // Populate semester selector
        const select = document.getElementById('semester-select');
        for (let i = 1; i <= 12; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Semestre ${i}`;
            select.appendChild(option);
        }
        
        // Get semester from URL or default to 1
        const urlParams = new URLSearchParams(window.location.search);
        currentSemester = parseInt(urlParams.get('sem')) || 1;
        select.value = currentSemester;
        
        // Initialize semester view
        loadSemester(currentSemester);
        
        // Populate other semesters for moving
        renderSemesterButtons();
    });
    
    function renderSemesterButtons() {
        const dropZones = document.getElementById('other-semesters-drop');
        dropZones.innerHTML = '';
        
        for (let i = 1; i <= 10; i++) {
            const zone = document.createElement('div');
            zone.id = `semester-btn-${i}`;
            zone.className = 'p-3 text-center text-sm font-medium rounded-lg border-2 border-dashed cursor-pointer transition-all ' +
                            (i === currentSemester ? 'border-accent-300 bg-accent-50 text-accent-600' : 'border-gray-300 hover:border-accent-300 hover:bg-accent-50 text-gray-600');
            zone.textContent = `S${i}`;
            zone.onclick = () => handleSemesterButtonClick(i);
            dropZones.appendChild(zone);
        }
    }
    
    function handleSemesterButtonClick(targetSemester) {
        if (selectedMateriaToMove) {
            // A materia is selected - move it to this semester
            if (targetSemester !== currentSemester) {
                showMoveConfirmation(selectedMateriaToMove, targetSemester);
            } else {
                // Clicking current semester deselects
                deselectMateria();
            }
        } else {
            // No materia selected - navigate to that semester
            loadSemester(targetSemester);
            renderSemesterButtons();
        }
    }
    
    function loadSemester(semesterNum) {
        currentSemester = parseInt(semesterNum);
        document.getElementById('semester-select').value = currentSemester;
        document.getElementById('current-semester-num').textContent = currentSemester;
        
        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('sem', currentSemester);
        window.history.pushState({}, '', url);
        
        // Deselect any selected materia
        deselectMateria();
        
        // Get materias for this semester
        const allMaterias = storage.getMaterias();
        const semesterMaterias = allMaterias.filter(m => m.semestre === currentSemester);
        
        renderSemesterCourses(semesterMaterias);
        updateSemesterStats(semesterMaterias);
        renderSemesterButtons();
    }
    
    function renderSemesterCourses(materias) {
        const grid = document.getElementById('semester-courses-grid');
        
        if (materias.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center py-12 text-gray-500">
                    <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    <p class="mt-2">No hay materias en este semestre</p>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = materias.map(m => renderCourseCard(m)).join('');
    }
    
    function renderCourseCard(materia) {
        const calificacion = storage.getCalificacion(materia.codigo);
        const grade = calificacion?.nota;
        
        const statusConfig = {
            'pending': { bg: 'bg-gray-50', border: 'border-gray-200', dot: 'bg-gray-300', label: 'Pendiente' },
            'enrolled': { bg: 'bg-blue-50', border: 'border-blue-200', dot: 'bg-blue-500', label: 'En curso' },
            'passed': { bg: 'bg-green-50', border: 'border-green-200', dot: 'bg-green-500', label: 'Aprobada' },
            'failed': { bg: 'bg-red-50', border: 'border-red-200', dot: 'bg-red-500', label: 'Reprobada' },
            'dropped': { bg: 'bg-yellow-50', border: 'border-yellow-200', dot: 'bg-yellow-500', label: 'Retirada' }
        };
        
        const status = statusConfig[materia.estado] || statusConfig.pending;
        
        return `
            <div id="course-card-${materia.codigo}" 
                 class="course-card ${status.bg} ${status.border} border-2 rounded-xl p-4 cursor-pointer hover:shadow-md transition-all"
                 onclick="handleCourseCardClick(event, '${materia.codigo}')">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center space-x-2">
                        <span class="w-2 h-2 rounded-full ${status.dot}"></span>
                        <span class="text-xs text-gray-500">${status.label}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm font-medium text-gray-600">${materia.creditos} cr</span>
                        <button onclick="event.stopPropagation(); selectMateriaForMove('${materia.codigo}')" 
                                class="p-1 text-gray-400 hover:text-accent-500 rounded" title="Mover a otro semestre">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <h4 class="font-semibold text-gray-900 mb-1">${materia.nombre}</h4>
                <p class="text-sm text-gray-500 mb-2">${materia.codigo}</p>
                ${materia.prerrequisitos?.length ? 
                    `<p class="text-xs text-gray-400">Req: ${materia.prerrequisitos.join(', ')}</p>` : ''}
                ${grade !== undefined ? 
                    `<div class="mt-2 pt-2 border-t border-gray-200">
                        <span class="text-lg font-bold ${grade >= 3 ? 'text-green-600' : 'text-red-600'}">${grade.toFixed(1)}</span>
                    </div>` : ''}
            </div>
        `;
    }
    
    function handleCourseCardClick(event, codigo) {
        if (selectedMateriaToMove === codigo) {
            // Clicking selected card deselects it
            deselectMateria();
        } else if (selectedMateriaToMove) {
            // Clicking another card while one is selected - switch selection
            selectMateriaForMove(codigo);
        } else {
            // No selection - open course modal for editing
            const materia = storage.getMateria(codigo);
            if (materia) {
                openCourseModalWithData(materia);
            }
        }
    }
    
    function selectMateriaForMove(codigo) {
        // Deselect previous if any
        if (selectedMateriaToMove) {
            const prevCard = document.getElementById(`course-card-${selectedMateriaToMove}`);
            if (prevCard) {
                prevCard.classList.remove('ring-2', 'ring-accent-500', 'ring-offset-2');
            }
        }
        
        selectedMateriaToMove = codigo;
        
        // Highlight selected card
        const card = document.getElementById(`course-card-${codigo}`);
        if (card) {
            card.classList.add('ring-2', 'ring-accent-500', 'ring-offset-2');
        }
        
        // Update semester buttons to show they're targets
        for (let i = 1; i <= 10; i++) {
            const btn = document.getElementById(`semester-btn-${i}`);
            if (btn && i !== currentSemester) {
                btn.classList.add('animate-pulse');
                btn.classList.remove('border-gray-300');
                btn.classList.add('border-accent-400', 'bg-accent-50');
            }
        }
        
        // Show instruction
        App.showAlert('Selecciona un semestre para mover la materia', 'info');
    }
    
    function deselectMateria() {
        if (selectedMateriaToMove) {
            const card = document.getElementById(`course-card-${selectedMateriaToMove}`);
            if (card) {
                card.classList.remove('ring-2', 'ring-accent-500', 'ring-offset-2');
            }
        }
        
        selectedMateriaToMove = null;
        
        // Reset semester buttons
        for (let i = 1; i <= 10; i++) {
            const btn = document.getElementById(`semester-btn-${i}`);
            if (btn) {
                btn.classList.remove('animate-pulse');
                if (i !== currentSemester) {
                    btn.classList.remove('border-accent-400', 'bg-accent-50');
                    btn.classList.add('border-gray-300');
                }
            }
        }
    }
    
    function showMoveConfirmation(codigo, targetSemester) {
        const materia = storage.getMateria(codigo);
        if (!materia) return;
        
        document.getElementById('move-modal-message').textContent = 
            `¿Mover "${materia.nombre}" (${codigo}) del Semestre ${currentSemester} al Semestre ${targetSemester}?`;
        
        // Store target for confirmation
        document.getElementById('move-confirm-btn').onclick = () => {
            confirmMove(codigo, targetSemester);
        };
        
        document.getElementById('move-modal').classList.remove('hidden');
    }
    
    function confirmMove(codigo, targetSemester) {
        const materia = storage.getMateria(codigo);
        if (!materia) return;
        
        // Update the materia's semester
        materia.semestre = targetSemester;
        storage.saveMateria(materia);
        
        // Close modal and reload
        closeMoveModal();
        deselectMateria();
        loadSemester(currentSemester);
        
        App.showAlert(`Materia movida al Semestre ${targetSemester}`, 'success');
    }
    
    function updateSemesterStats(materias) {
        // Credits
        const totalCredits = materias.reduce((sum, m) => sum + (m.creditos || 0), 0);
        document.getElementById('semester-credits').textContent = totalCredits;
        
        // Courses count
        document.getElementById('semester-courses-count').textContent = materias.length;
        
        // Calculate GPA
        const calificaciones = storage.getCalificaciones();
        let totalPoints = 0;
        let gradedCredits = 0;
        
        materias.forEach(m => {
            const cal = calificaciones.find(c => c.codigo_materia === m.codigo);
            if (cal && cal.nota !== null && cal.nota !== undefined) {
                totalPoints += cal.nota * m.creditos;
                gradedCredits += m.creditos;
            }
        });
        
        const gpa = gradedCredits > 0 ? (totalPoints / gradedCredits) : 0;
        const gpaEl = document.getElementById('semester-gpa');
        gpaEl.textContent = gpa > 0 ? gpa.toFixed(2) : '--';
        
        // Status
        const passed = materias.filter(m => m.estado === 'passed').length;
        const enrolled = materias.filter(m => m.estado === 'enrolled').length;
        const statusEl = document.getElementById('semester-status');
        
        if (passed === materias.length && materias.length > 0) {
            statusEl.innerHTML = '<span class="text-green-600">Completado ✓</span>';
        } else if (enrolled > 0) {
            statusEl.innerHTML = '<span class="text-blue-600">En progreso</span>';
        } else {
            statusEl.innerHTML = '<span class="text-gray-500">Pendiente</span>';
        }
    }
    
    // Course modal functionality is handled by the course_modal.html component
    // The openCourseModalWithData() function is defined there
    
    function closeMoveModal() {
        document.getElementById('move-modal').classList.add('hidden');
    }
</script>
{% endblock %}
